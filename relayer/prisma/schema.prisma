generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model NetworkStatus {
  chain              String   @id
  lastProcessedBlock BigInt
  updatedAt          DateTime @updatedAt
}

model Nonce {
  chain String @id
  value BigInt
}

model Transaction {
  id                     Int          @id @default(autoincrement())
  sourceChain            CHAIN        @default(EVM)
  eventName              BRIDGE_EVENT @default(LOCKED_CANONICAL) // "LockedCanonical"
  sourceTxHash           String
  sourceLogIndex         Int?
  eventId                String       @unique // keccak256(...) OR `${txHash}:${logIndex}`
  sourceBlockNumber      BigInt
  token                  String
  sender                 String
  amount                 String
  netAmount              String?
  feeAmount              String?
  nonce                  BigInt?
  destChainId            String
  destAddress            String
  destinationTxHash      String?
  destinationBlockNumber BigInt?
  status                 TX_STATUS    @default(LOCKED)
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt

  sourceChainRefId Int?
  destChainRefId   Int?
  tokenRefId       Int?

  sourceChainRef Chain? @relation("SourceChain", fields: [sourceChainRefId], references: [id])
  destChainRef   Chain? @relation("DestChain", fields: [destChainRefId], references: [id])
  tokenRef       Token? @relation(fields: [tokenRefId], references: [id])

  @@unique([sourceTxHash, sourceLogIndex])
}

model Chain {
  id          Int      @id @default(autoincrement())
  name        String   @unique // e.g., "ethereum", "base", "casper"
  kind        CHAIN
  chainId     Int?
  displayName String?
  logoUrl     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sourceTransactions Transaction[] @relation("SourceChain")
  destTransactions   Transaction[] @relation("DestChain")
  tokens             Token[]
  sourceTokenPairs   TokenPair[]   @relation("SourceChain")
  destTokenPairs     TokenPair[]   @relation("DestChain")

  @@unique([kind, chainId])
}

model Token {
  id              Int      @id @default(autoincrement())
  chainId         Int
  name            String
  symbol          String
  decimals        Int
  logoUrl         String?
  contractAddress String?
  contractHash    String?
  contractPackageHash String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  chain            Chain         @relation(fields: [chainId], references: [id])
  transactions     Transaction[]
  sourceTokenPairs TokenPair[]   @relation("SourceToken")
  destTokenPairs   TokenPair[]   @relation("DestToken")

  @@unique([chainId, contractAddress])
  @@unique([chainId, contractHash])
  @@unique([chainId, contractPackageHash])
  @@index([chainId, contractAddress])
  @@index([chainId, contractHash])
  @@index([chainId, contractPackageHash])
}

model TokenPair {
  id            Int      @id @default(autoincrement())
  sourceChainId Int
  destChainId   Int
  sourceTokenId Int
  destTokenId   Int
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sourceChain Chain @relation("SourceChain", fields: [sourceChainId], references: [id])
  destChain   Chain @relation("DestChain", fields: [destChainId], references: [id])
  sourceToken Token @relation("SourceToken", fields: [sourceTokenId], references: [id])
  destToken   Token @relation("DestToken", fields: [destTokenId], references: [id])

  @@unique([sourceChainId, sourceTokenId, destChainId])
  @@index([destChainId, destTokenId])
}

enum CHAIN {
  EVM
  CASPER
}

enum BRIDGE_EVENT {
  LOCKED_CANONICAL
  BURNED_WRAPPED
  MINTED_WRAPPED
  UNLOCKED_CANONICAL
}

enum TX_STATUS {
  LOCKED // canonical locked on source
  BURNED // wrapped burned on source

  QUEUED // picked up by relayer
  EXECUTING // tx sent to destination chain

  EXECUTED // mint/unlock succeeded
  FAILED // execution failed (retryable)

  FINALIZED // optional: confirmed & irreversible
}
